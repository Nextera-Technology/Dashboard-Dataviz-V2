<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-container">
            <img src="https://staging-sg-map-bucket.s3.ap-southeast-1.amazonaws.com/public/Nextera%20Logo%20Career%20Insight%20White%20text.png"
                alt="Nextera Logo" />
        </div>

        <!-- User Info -->
        <div class="user-info">
            <div class="user-avatar">
                <mat-icon>person</mat-icon>
            </div>
            <div class="user-details">
                <p class="user-name">{{ currentUser?.name }}</p>
                <p class="user-email">{{ currentUser?.email }}</p>
                <p class="user-role">{{ currentUser?.role | titlecase }}</p>
            </div>
        </div>

        <!-- Certification Filter Section -->
        <div class="filter-section">
            <div class="section-title">
                <span class="section-icon">üìä</span>
                {{ 'dashboard.sidebar.certification' | translate }}
            </div>

            <!-- Search Input -->
            <div class="typeahead-container">
                <input type="text" class="typeahead-input" placeholder="{{ 'dashboard.sidebar.search_placeholder' | translate }}"
                    [(ngModel)]="certificationSearch" (input)="onCertificationSearch()" />
            </div>

            <!-- Main Checkbox List -->
            <div class="checkbox-list">

                <!-- Select All -->
                <label class="checkbox-item select-all">
                    <input type="checkbox" id="cert_select_all" (change)="toggleCertificationSelectAll()" />
                    {{ 'dashboard.sidebar.select_all' | translate }}
                </label>

                <!-- Each Certification Item -->
                <div class="certification-item" *ngFor="let cert of filteredCertifications">

                    <!-- Parent Row -->
                    <div class="checkbox-item">
                        <!-- Parent Checkbox (label wraps input and text to make full area clickable) -->
                        <label [for]="'cert_' + cert.name">
                            <input type="checkbox" [id]="'cert_' + cert.name" [(ngModel)]="cert.selected" />
                            {{ cert.name }}
                        </label>
                        <!-- Expand/Collapse Icon -->
                        <button *ngIf="cert.children?.length" (click)="cert.expanded = !cert.expanded" type="button"
                            class="toggle-button">
                            {{ cert.expanded ? '‚ñ¥' : '‚ñæ' }}
                        </button>
                    </div>
                    

                    <!-- Child List -->
                    <div *ngIf="cert.expanded" class="child-list">
                        <label class="checkbox-item" *ngFor="let child of cert.children">
                            <input type="checkbox" [id]="'cert_' + child" [(ngModel)]="selectedChildren[child]" />
                            {{ child }}
                        </label>
                    </div>
                </div>

                <!-- Selected Count -->
                <div class="selected-count">
                    {{ selectedCertificationsCount }} {{ 'dashboard.sidebar.selected_certifications' | translate }}
                </div>

                <!-- Apply Button -->
                <button class="clear-filters" (click)="applyCertificationFilters()">
                    {{ 'dashboard.sidebar.apply_filters' | translate }}
                </button>
            </div>
        </div>


        <!-- Sections Filter Section -->
        <div class="filter-section">
            <div class="section-title sections-title">
                <span class="section-icon">üìã</span>
                {{ 'dashboard.sidebar.sections' | translate }}
            </div>
            <div class="checkbox-list">
                <label class="checkbox-item" *ngFor="let section of sectionsList; let i = index">
                    <input type="checkbox" [id]="'section_' + section._id" [checked]="true"
                        (change)="onCheckboxChange(section.name, $event.target.checked)">
                    {{ section.name }}
                </label>
            </div>
            <div class="selected-count">{{ selectedSectionsCount }} {{ 'dashboard.sidebar.selected_sections' | translate }}</div>
            <button class="clear-filters" (click)="applySectionFilters()">{{ 'dashboard.sidebar.apply_filters' | translate }}</button>
        </div>

        <!-- Admin Navigation Section -->
        <div class="admin-section" *ngIf="isAdminUser()">
            <div class="section-title admin-title">
                <span class="section-icon">‚öôÔ∏è</span>
                {{ 'admin.layout.title' | translate }}
            </div>
            <div class="admin-menu">
                <a routerLink="/admin/dashboard-list" class="admin-menu-item">
                    <mat-icon>dashboard</mat-icon>
                    <span>{{ 'admin.dashboardList.header_title' | translate }}</span>
                </a>
                <a routerLink="/admin/user-management" class="admin-menu-item">
                    <mat-icon>people</mat-icon>
                    <span>{{ 'admin.layout.userManagement' | translate }}</span>
                </a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header>
            <div class="header-content">
                <h1>{{ dashboard?.title || 'Dashboard' }}</h1>
                <h4>{{ dashboard?.subtitle || ('admin.dashboardBuilder.data_source_label' | translate) }}</h4>
            </div>

            <!-- language dropdown removed from here and moved into user-menu to align right next to profile -->

            <!-- Language dropdown placed to the left of profile icon (right-top) -->
            <div style="display:flex; align-items:center; gap:8px; margin-left:auto;">
              <div class="lang-dropdown" style="position:relative;" (click)="$event.stopPropagation()">
                <button mat-button class="lang-toggle" aria-haspopup="true" (click)="openLangMenu($event)" style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 8px;">
                  <img [src]="currentFlag()" alt="lang" style="width:22px;height:16px;object-fit:cover;border-radius:2px;box-shadow:0 1px 2px rgba(0,0,0,0.1)" />
                  <span style="font-size:11px;font-weight:600;line-height:1">{{ translation.getCurrentLanguage() | uppercase }}</span>
                </button>
                <div *ngIf="langMenuOpen" class="lang-menu" style="position:absolute;right:0;top:36px;background:#fff;border:1px solid #e6e6e6;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);overflow:hidden;min-width:140px;z-index:200">
                  <button class="lang-item" (click)="setLanguage('en')" style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:transparent;border:none;width:100%;text-align:left"> 
                    <img src="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/flags/4x3/gb.svg" alt="EN" style="width:20px;height:14px;object-fit:cover" />
                    <span>English</span>
                  </button>
                  <button class="lang-item" (click)="setLanguage('fr')" style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:transparent;border:none;width:100%;text-align:left"> 
                    <img src="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/flags/4x3/fr.svg" alt="FR" style="width:20px;height:14px;object-fit:cover" />
                    <span>Fran√ßais</span>
                  </button>
                </div>
              </div>

              <!-- User Menu -->
            </div>

            <div class="user-menu">
                <button mat-icon-button [matMenuTriggerFor]="userMenu" class="user-menu-button">
                    <mat-icon>account_circle</mat-icon>
                </button>
                <mat-menu #userMenu="matMenu">
                    <div class="menu-header">
                        <p class="menu-name">{{ currentUser?.name }}</p>
                        <p class="menu-email">{{ currentUser?.email }}</p>
                        <p class="menu-role">{{ currentUser?.role | titlecase }}</p>
                    </div>
                    <button mat-menu-item (click)="logout()">
                        <mat-icon>logout</mat-icon>
                        <span>{{ 'shared.logout' | translate }}</span>
                    </button>
                </mat-menu>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Sections -->
            <app-section *ngFor="let section of dashboard?.sectionIds; trackBy: trackBySection" [section]="section">
            </app-section>
        </div>
    </main>
</div>
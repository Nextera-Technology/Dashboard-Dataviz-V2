<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar" [class.collapsed]="isSidebarCollapsed">
        <div class="logo-container">
            <img src="https://staging-alumni-dataviz.s3.ap-southeast-1.amazonaws.com/public/logo+with+text+right.png"
                alt="Nextera Logo" />
        </div>

        <!-- User Info -->
        <div class="user-info">
            <div class="user-avatar">
                <mat-icon>person</mat-icon>
            </div>
            <div class="user-details" *ngIf="!isSidebarCollapsed">
                <p class="user-name">{{ currentUser?.name }}</p>
                <p class="user-email">{{ currentUser?.email }}</p>
                <p class="user-role">{{ currentUser?.role | titlecase }}</p>
            </div>
        </div>

        <!-- Certification Filter Section -->
        <div class="filter-section" *ngIf="!isSidebarCollapsed">
            <div class="section-title">
                <span class="section-icon">üìä</span>
                {{ 'dashboard.sidebar.certification' | translate }}
            </div>

            <!-- Search Input -->
            <div class="typeahead-container">
                <input type="text" class="typeahead-input" placeholder="{{ 'dashboard.sidebar.search_placeholder' | translate }}"
                    [(ngModel)]="certificationSearch" (input)="onCertificationSearch()" />
            </div>

            <!-- Main Checkbox List -->
            <div class="checkbox-list">

                <!-- Select All -->
                <label class="checkbox-item select-all">
                    <input type="checkbox" id="cert_select_all" (change)="toggleCertificationSelectAll()" />
                    {{ 'dashboard.sidebar.select_all' | translate }}
                </label>

                <!-- Each Certification Item -->
                <div class="certification-item" *ngFor="let cert of filteredCertifications">

                    <!-- Parent Row -->
                    <div class="checkbox-item">
                        <!-- Parent Checkbox (label wraps input and text to make full area clickable) -->
                        <label [for]="'cert_' + cert.name">
                            <input type="checkbox" [id]="'cert_' + cert.name" [(ngModel)]="cert.selected" />
                            {{ cert.name }}
                        </label>
                        <!-- Expand/Collapse Icon -->
                        <button *ngIf="cert.children?.length" (click)="cert.expanded = !cert.expanded" type="button"
                            class="toggle-button">
                            {{ cert.expanded ? '‚ñ¥' : '‚ñæ' }}
                        </button>
                    </div>
                    

                    <!-- Child List -->
                    <div *ngIf="cert.expanded" class="child-list">
                        <label class="checkbox-item" *ngFor="let child of cert.children">
                            <input type="checkbox" [id]="'cert_' + child" [(ngModel)]="selectedChildren[child]" />
                            {{ child }}
                        </label>
                    </div>
                </div>

                <!-- Selected Count -->
                <div class="selected-count">
                    {{ selectedCertificationsCount }} {{ 'dashboard.sidebar.selected_certifications' | translate }}
                </div>

                <!-- Apply Button -->
                <button class="clear-filters" (click)="applyCertificationFilters()">
                    {{ 'dashboard.sidebar.apply_filters' | translate }}
                </button>
            </div>
        </div>


        <!-- Sections Filter Section -->
        <div class="filter-section" *ngIf="!isSidebarCollapsed">
            <div class="section-title sections-title">
                <span class="section-icon">üìã</span>
                {{ 'dashboard.sidebar.sections' | translate }}
            </div>
            <div class="checkbox-list">
                <label class="checkbox-item" *ngFor="let section of sectionsList; let i = index">
                    <input type="checkbox" 
                           [id]="'sidebar_section_' + section._id" 
                           [checked]="sidebarSectionVisibility[section._id]"
                           (change)="onSidebarCheckboxChange(section._id, $event.target.checked)">
                    {{ section.name }}
                </label>
            </div>
            <div class="selected-count">{{ getVisibleSectionsCount() }} {{ 'dashboard.sidebar.selected_sections' | translate }}</div>
            <button class="clear-filters" (click)="applySectionFilters()">{{ 'dashboard.sidebar.apply_filters' | translate }}</button>
        </div>

        <!-- Admin Navigation Section with Expandable Menus -->
        <div class="admin-section" *ngIf="isAdminUser() && !isSidebarCollapsed">
            <div class="section-title admin-title">
                <span class="section-icon">‚öôÔ∏è</span>
                {{ 'admin.layout.title' | translate }}
            </div>
            <div class="admin-menu">
                <!-- Dashboard Builder - Direct Link -->
                <a routerLink="/admin/dashboard-list" routerLinkActive="active" class="nav-item">
                    <mat-icon>dashboard</mat-icon>
                    <span>{{ 'admin.dashboardList.header_title' | translate }}</span>
                </a>

                <!-- Job Description - Direct Link -->
                <a routerLink="/admin/job-description" routerLinkActive="active" class="nav-item">
                    <mat-icon>work</mat-icon>
                    <span>{{ 'admin.layout.jobDescription' | translate }}</span>
                </a>

                <!-- User Management -->
                <a routerLink="/admin/user-management" routerLinkActive="active" class="nav-item">
                    <mat-icon>people</mat-icon>
                    <span>{{ 'admin.layout.userManagement' | translate }}</span>
                </a>
            </div>
        </div>

        <!-- Collapsed Icon Menu -->
        <div class="collapsed-menu" *ngIf="isSidebarCollapsed">
            <!-- Certification Filter Icon -->
            <div class="collapsed-menu-item" [matTooltip]="'dashboard.sidebar.certification' | translate" matTooltipPosition="right">
                <mat-icon>filter_list</mat-icon>
            </div>

            <!-- Sections Filter Icon -->
            <div class="collapsed-menu-item" [matTooltip]="'dashboard.sidebar.sections' | translate" matTooltipPosition="right">
                <mat-icon>view_agenda</mat-icon>
            </div>

            <!-- Admin Dashboard Builder Icon -->
            <a *ngIf="isAdminUser()" routerLink="/admin/dashboard-list" class="collapsed-menu-item" 
               [matTooltip]="'admin.dashboardList.header_title' | translate" matTooltipPosition="right">
                <mat-icon>dashboard</mat-icon>
            </a>

            <!-- Job Description Icon (Admin only) -->
            <a *ngIf="isAdminUser()" routerLink="/admin/job-description" class="collapsed-menu-item" 
               [matTooltip]="'admin.layout.jobDescription' | translate" matTooltipPosition="right">
                <mat-icon>work</mat-icon>
            </a>

            <!-- Admin User Management Icon -->
            <a *ngIf="isAdminUser()" routerLink="/admin/user-management" class="collapsed-menu-item" 
               [matTooltip]="'admin.layout.userManagement' | translate" matTooltipPosition="right">
                <mat-icon>people</mat-icon>
            </a>
        </div>
        <div class="sidebar-footer">
          <button type="button" (click)="toggleSidebar()" class="toggle-btn" [attr.aria-label]="isSidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'" [attr.aria-pressed]="isSidebarCollapsed">
            <mat-icon>{{ isSidebarCollapsed ? 'chevron_right' : 'chevron_left' }}</mat-icon>
          </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" [class.collapsed]="isSidebarCollapsed">
        <header>
            <div class="header-content">
                <h1>{{ dashboard?.title || 'Dashboard' }}</h1>
                <h4>{{ getDataSourceDisplay() }}</h4>
                <h5 *ngIf="isJobDescriptionDashboard() && dashboard?.currentSchools" class="schools-info">
                    Schools: {{ dashboard.currentSchools }}
                </h5>
            </div>

            <!-- QuickSearch in header -->
            <div class="quicksearch-wrapper">
              <app-quick-search></app-quick-search>
            </div>

            <div class="header-right">
              <button mat-icon-button (click)="toggleTheme()" class="theme-toggle" [matTooltip]="currentTheme === 'theme-dark' ? 'Light mode' : 'Dark mode'">
                <mat-icon>{{ currentTheme === 'theme-dark' ? 'light_mode' : 'dark_mode' }}</mat-icon>
              </button>
              <!-- Language dropdown placed to the left of profile icon (right-top) -->
              <div class="lang-dropdown" style="position:relative;" (click)="$event.stopPropagation()">
                <button mat-button class="lang-toggle" aria-haspopup="true" (click)="openLangMenu($event)" style="display:flex;align-items:center;padding:6px 8px;">
                  <img [src]="currentFlag()" alt="lang" style="width:22px;height:16px;object-fit:cover;border-radius:2px;box-shadow:0 1px 2px rgba(0,0,0,0.1)" />
                </button>
                <div *ngIf="langMenuOpen" class="lang-menu" style="position:absolute;right:0;top:36px;background:#fff;border:1px solid #e6e6e6;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);overflow:hidden;min-width:140px;z-index:8500">
                  <button class="lang-item" (click)="setLanguage('en')" style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:transparent;border:none;width:100%;text-align:left"> 
                    <img src="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/flags/4x3/gb.svg" alt="EN" style="width:20px;height:14px;object-fit:cover" />
                    <span>English</span>
                  </button>
                  <button class="lang-item" (click)="setLanguage('fr')" style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:transparent;border:none;width:100%;text-align:left"> 
                    <img src="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/flags/4x3/fr.svg" alt="FR" style="width:20px;height:14px;object-fit:cover" />
                    <span>Fran√ßais</span>
                  </button>
                </div>
              </div>

              <!-- User Menu -->
              <div class="user-menu">
                <button mat-icon-button [matMenuTriggerFor]="userMenu" class="user-menu-button">
                    <mat-icon>account_circle</mat-icon>
                </button>
                <mat-menu #userMenu="matMenu">
                    <div class="menu-header">
                        <p class="menu-name">{{ currentUser?.name }}</p>
                        <p class="menu-email">{{ currentUser?.email }}</p>
                        <p class="menu-role">{{ currentUser?.role | titlecase }}</p>
                    </div>
                    <button mat-menu-item (click)="logout()">
                        <mat-icon>logout</mat-icon>
                        <span>{{ 'shared.logout' | translate }}</span>
                    </button>
                </mat-menu>
              </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Frozen Section Header -->
            <div class="frozen-sections-header" *ngIf="dashboard?.sectionIds && dashboard.sectionIds.length > 0">
                <div class="sections-nav">
                    <div class="section-nav-item" *ngFor="let section of dashboard.sectionIds; let i = index" 
                         [class.section-hidden]="!sectionVisibility[section._id]">
                        
                        <!-- Checkbox for visibility control -->
                        <div class="nav-checkbox-wrapper">
                            <input type="checkbox" 
                                   [id]="'nav_section_' + section._id" 
                                   [checked]="sectionVisibility[section._id]"
                                   (change)="toggleSectionVisibility(section._id, $event)"
                                   (click)="$event.stopPropagation()">
                        </div>
                        
                        <!-- Navigation Button -->
                        <button class="section-nav-button" 
                                (click)="navigateToSection(section._id)"
                                [disabled]="!sectionVisibility[section._id]"
                                [style.background-color]="getSectionBackgroundColor(section)"
                                [style.color]="getSectionTextColor(section)">
                            <span class="section-nav-name">
                                {{ section.name }}
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sections -->
            <div class="sections-container">
                <app-section *ngFor="let section of visibleSections; trackBy: trackBySection" 
                           [section]="section"
                           [id]="'section-' + section._id"
                           [class.section-visible]="sectionVisibility[section._id]">
                </app-section>
            </div>
        </div>
    </main>

    <!-- Floating Chat Component -->
    <app-floating-chat></app-floating-chat>
</div>

<app-admin-layout>
    <div class="dashboard-builder flex flex-col h-screen bg-gray-100">
        <div
            class="header flex flex-col items-center px-6 py-5 border-b border-gray-200 bg-white shadow-sm z-10 sticky top-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">
                {{ dashboard?.title || 'Loading Dashboard...' }}
            </h1>
            <div class="w-full flex justify-between items-center">
                <div class="header-left flex items-center gap-4">
                    <button mat-button (click)="goBack()" class="text-blue-600 hover:text-blue-800">
                        <mat-icon>arrow_back</mat-icon>
                        <span class="ml-2">Back to Dashboards</span>
                    </button>
                </div>
                <div class="header-actions flex gap-3">
                    <button mat-button (click)="viewDashboard()" matTooltip="View Dashboard" [matTooltipClass]="'inter-tooltip'"
                        class="flex items-center space-x-1 px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors duration-200">
                        <mat-icon>visibility</mat-icon>
                        <span>View Dashboard</span>
                    </button>
                    <button mat-button (click)="regenerateAnalysis()" matTooltip="Regenerate Analysis" [matTooltipClass]="'inter-tooltip'"
                        class="flex items-center space-x-1 px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors duration-200">
                        <mat-icon>refresh</mat-icon>
                        <span>Regenerate Analysis</span>
                    </button>
                    <button mat-button (click)="addSection()" matTooltip="Add New Section" [matTooltipClass]="'inter-tooltip'"
                        class="flex items-center space-x-1 px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors duration-200">
                        <mat-icon>add</mat-icon>
                        <span>Add Section</span>
                    </button>
                    <button mat-raised-button color="primary" (click)="saveDashboard()" matTooltip="Save Dashboard" [matTooltipClass]="'inter-tooltip'"
                        class="flex items-center space-x-2 px-6 py-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                        <mat-icon>save</mat-icon>
                        <span>Save Dashboard</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="builder-content flex-1 overflow-hidden">
            <!-- Custom draggable tab headers -->
            <div class="custom-tab-header flex border-b border-gray-200 bg-white" cdkDropList
                cdkDropListOrientation="horizontal" (cdkDropListDropped)="onSectionDrop($event)">
                <div *ngFor="let section of dashboard?.sectionIds; trackBy: trackById; let i = index" cdkDrag
                    class="custom-tab-item px-4 py-3" [class.active-tab]="selectedTabIndex === i"
                    (click)="selectedTabIndex = i; onTabChange(i)">
                    <div class="flex items-center gap-2">
                        <mat-icon cdkDragHandle>drag_indicator</mat-icon>
                        <span>{{ section.title }}</span>
                    </div>
                </div>
                <div *ngIf="!dashboard?.sectionIds || dashboard?.sectionIds.length === 0"
                    class="custom-tab-item px-4 py-3 active-tab">
                    <span>No Sections</span>
                </div>
            </div>

            <!-- Tab content -->
            <div class="tab-content flex-1">
                <ng-container *ngIf="dashboard?.sectionIds && dashboard?.sectionIds.length > 0">
                    <div *ngFor="let section of dashboard?.sectionIds; let i = index" [hidden]="selectedTabIndex !== i"
                        class="h-full overflow-y-auto">
                        <div
                            class="section-header flex justify-between items-center py-4 px-6 border-b border-gray-200 shadow-sm sticky top-0 z-10"
                            [style.background-color]="section?.background || '#ffffff'">
                            <div class="section-info">
                                <h3 class="text-xl font-semibold text-gray-800">
                                    {{ section.title }}
                                </h3>
                                <span class="text-sm text-gray-500">{{ section?.widgetIds.length }} widgets</span>
                            </div>
                            <div class="section-actions flex gap-2">
                                <button mat-icon-button (click)="editSection(section)" matTooltip="Edit Section"
                                    class="text-gray-600 hover:text-blue-600">
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button mat-icon-button (click)="deleteSection(section)" matTooltip="Delete Section"
                                    class="text-gray-600 hover:text-red-600">
                                    <mat-icon>delete</mat-icon>
                                </button>
                                <button mat-icon-button (click)="addWidget(section)" matTooltip="Add Widget to Section"
                                    class="text-gray-600 hover:text-green-600">
                                    <mat-icon>add_box</mat-icon>
                                </button>
                            </div>
                        </div>

                        <div class="widget-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 auto-rows-[230px] gap-6 p-6"
                            [style.background-color]="section?.background || '#ffffff'"
                            cdkDropList cdkDropListOrientation="mixed" [cdkDropListData]="section?.widgetIds"
                            (cdkDropListDropped)="onWidgetDrop($event, i)">
                            <div class="widget-card rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-blue-400 transition-all duration-300 ease-in-out cursor-grab flex flex-col"
                                [style.background-color]="widget?.background || '#ffffff'"
                                *ngFor="let widget of section?.widgetIds; trackBy: trackById" cdkDrag
                                [class.col-span-1]="widget.columnSize === 1"
                                [class.col-span-2]="widget.columnSize === 2"
                                [class.col-span-3]="widget.columnSize === 3"
                                [class.col-span-4]="widget.columnSize === 4" [class.row-span-1]="widget.rowSize === 1"
                                [class.row-span-2]="widget.rowSize === 2" [class.row-span-3]="widget.rowSize === 3"
                                [class.row-span-4]="widget.rowSize === 4" #widgetCard>
                                <ng-template cdkDragPreview>
                                    <div
                                        class="simplified-widget-preview bg-blue-500 text-white p-3 rounded-lg shadow-lg flex items-center justify-center">
                                        <mat-icon>drag_indicator</mat-icon>
                                        <span class="ml-2 text-sm font-medium">{{ widget.title }}</span>
                                    </div>
                                </ng-template>

                                <ng-template cdkDragPlaceholder>
                                    <div
                                        class="widget-placeholder border-2 border-dashed border-gray-400 rounded-lg bg-gray-100 opacity-50 flex items-center justify-center">
                                    </div>
                                </ng-template>

                                <div
                                    class="widget-header flex justify-between items-center p-4 border-b border-gray-100">
                                    <h3 class="text-base font-medium text-gray-900 truncate">{{ widget.title }}</h3>
                                    <div class="widget-actions flex gap-1">
                                        <button mat-icon-button matTooltip="Edit Widget" (click)="editWidget(widget)"
                                            class="text-gray-500 hover:text-blue-600">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                        <button mat-icon-button matTooltip="Delete Widget"
                                            (click)="deleteWidget(widget)" class="text-gray-500 hover:text-red-600">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                        <button mat-icon-button cdkDragHandle matTooltip="Move Widget"
                                            class="text-gray-500 hover:text-gray-800 cursor-grab">
                                            <mat-icon>drag_indicator</mat-icon>
                                        </button>
                                    </div>
                                </div>

                                <div class="widget-content flex-1 flex flex-col p-4 overflow-hidden"
     [ngClass]="{
       'content-scroll': isPieChartOneByOne(widget) || isNonPieChartOneByOne(widget) || isTwoByOne(widget) || isOneByTwo(widget)
     }">
                                    <div class="flex-1 min-h-0"
                                         [ngClass]="{ 'has-scroll': isPieChartOneByOne(widget) || isNonPieChartOneByOne(widget) || isTwoByOne(widget) || isOneByTwo(widget) }">
                                        <ng-container>
                                            <app-metric-widget *ngIf="widget.chartType === 'CARD' && !(widget?.widgetType === 'STATUS_BY_WAVE'  || widget?.widgetSubType === 'STATUS_WAVE_BREAKDOWN')" [widget]="widget" [data]="widget.data" class="h-full"></app-metric-widget>
                                            <app-breakdown-chart-widget *ngIf="widget.chartType === 'CARD'  && (widget?.widgetType === 'STATUS_BY_WAVE'  || widget?.widgetSubType === 'STATUS_WAVE_BREAKDOWN')" [widget]="widget" [data]="widget.data" class="h-full"></app-breakdown-chart-widget>
                                            <app-bar-chart-widget *ngIf="widget.chartType === 'CLUSTERED_BAR_CHART'  || widget.chartType === 'SORTED_BAR_CHART' || widget.chartType === 'SortedBarChart' || widget.chartType === 'sorted_bar_chart'" [widget]="widget" [data]="widget.data" class="h-full"></app-bar-chart-widget>
                                            <app-column-chart-widget *ngIf="widget.chartType === 'ColumnChart' || widget.chartType === 'CLUSTERED_COLUMN_CHART' || widget.chartType === 'HorizontalStackedChart' || widget.chartType === 'VerticalStackedChart'" [widget]="widget" [data]="widget.data" class="h-full"></app-column-chart-widget>
                                            <app-line-chart-widget *ngIf="widget.chartType === 'LINE_CHART_WITH_DATA_LABELS' || widget.chartType === 'LineChart'" [widget]="widget" [data]="widget.data" class="h-full"></app-line-chart-widget>
                                            <app-pie-chart-widget *ngIf="widget.chartType === 'PIE_CHART_BROKEN_DOWN_SLICES' || widget.chartType === 'PieChart' || widget.chartType === 'SlicedChart'" [widget]="widget" [data]="widget.data" class="h-full"></app-pie-chart-widget>
                                            <app-donut-chart-widget *ngIf="widget.chartType === 'donut' || widget.chartType === 'Donut' || widget.chartType === 'DONUT' || widget.chartType === 'donut_chart'" [widget]="widget" [data]="widget.data" class="h-full"></app-donut-chart-widget>
                                            <app-pictorial-fraction-chart *ngIf="widget.chartType === 'PICTORIAL_FRACTION_CHART'" [widget]="widget" [data]="widget.data" class="h-full"></app-pictorial-fraction-chart>
                                            <app-status-grid-widget *ngIf="widget.chartType === 'StatusGrid'" [widget]="widget" [data]="widget.data" class="h-full"></app-status-grid-widget>
                                            <app-world-map-widget *ngIf="widget.chartType === 'DRILL_DOWN_MAP'" [widget]="widget" [data]="widget.data" class="h-full"></app-world-map-widget>
                                            <app-radar-chart-widget *ngIf="widget.chartType === 'RadialBarChart' || widget.chartType === 'RadarChart' || widget.chartType === 'radialbarchart' || widget.chartType === 'radarchart' || widget.chartType === 'RADAR_CHART' || widget.chartType === 'radar_chart' || widget.chartType === 'RADIAL_BAR_CHART' || widget.chartType === 'radial_bar_chart'" [widget]="widget" [data]="widget.data" class="h-full"></app-radar-chart-widget>
                                            <app-animated-gauge-widget *ngIf="widget.chartType === 'ANIMATED_GAUGE' || widget.chartType === 'animated_gauge' || widget.chartType === 'AnimatedGauge'" [widget]="widget" [data]="widget.data" class="h-full"></app-animated-gauge-widget>
                                            <app-yes-no-gauge-widget *ngIf="widget.chartType === 'YES_NO_GAUGE' || widget.chartType === 'yes_no_gauge' || widget.chartType === 'YesNoGauge'" [widget]="widget" [data]="widget.data" class="h-full"></app-yes-no-gauge-widget>
                                            <app-sankey-chart-widget *ngIf="widget.chartType === 'TraceableSankee' || widget.chartType === 'TRACEABLE_SANKEY_DIAGRAM'" [widget]="widget" [data]="widget.data" class="h-full"></app-sankey-chart-widget>
                                            <app-map-widget *ngIf="widget.chartType === 'MapChart'" [widget]="widget" [data]="widget.data" class="h-full"></app-map-widget>
                                            <app-simple-table-widget *ngIf="widget.chartType === 'Table'" [widget]="widget" [data]="widget.data" class="h-full"></app-simple-table-widget>
                                            <app-text-widget *ngIf="widget.chartType === 'Text'" [widget]="widget" [data]="widget.data" class="h-full"></app-text-widget>
                                            <div *ngIf="!(
                                                widget.chartType === 'CARD' ||
                                                widget.chartType === 'CLUSTERED_BAR_CHART' ||
                                                widget.chartType === 'CLUSTERED_COLUMN_CHART' ||
                                                widget.chartType === 'SORTED_BAR_CHART' ||
                                                widget.chartType === 'SortedBarChart' ||
                                                widget.chartType === 'sorted_bar_chart' ||
                                                widget.chartType === 'ColumnChart' ||
                                                widget.chartType === 'HorizontalStackedChart' ||
                                                widget.chartType === 'VerticalStackedChart' ||
                                                widget.chartType === 'LINE_CHART_WITH_DATA_LABELS' ||
                                                widget.chartType === 'LineChart' ||
                                                widget.chartType === 'PIE_CHART_BROKEN_DOWN_SLICES' ||
                                                widget.chartType === 'PieChart' ||
                                                widget.chartType === 'SlicedChart' ||
                                                widget.chartType === 'donut' ||
                                                widget.chartType === 'Donut' ||
                                                widget.chartType === 'DONUT' ||
                                                widget.chartType === 'donut_chart' ||
                                                widget.chartType === 'PICTORIAL_FRACTION_CHART' ||
                                                widget.chartType === 'StatusGrid' ||
                                                widget.chartType === 'DRILL_DOWN_MAP' ||
                                                widget.chartType === 'RadialBarChart' ||
                                                widget.chartType === 'RadarChart' ||
                                                widget.chartType === 'radialbarchart' ||
                                                widget.chartType === 'radarchart' ||
                                                widget.chartType === 'RADAR_CHART' ||
                                                widget.chartType === 'radar_chart' ||
                                                widget.chartType === 'RADIAL_BAR_CHART' ||
                                                widget.chartType === 'radial_bar_chart' ||
                                                widget.chartType === 'ANIMATED_GAUGE' ||
                                                widget.chartType === 'animated_gauge' ||
                                                widget.chartType === 'AnimatedGauge' ||
                                                widget.chartType === 'YES_NO_GAUGE' ||
                                                widget.chartType === 'yes_no_gauge' ||
                                                widget.chartType === 'YesNoGauge' ||
                                                widget.chartType === 'TraceableSankee' ||
                                                widget.chartType === 'TRACEABLE_SANKEY_DIAGRAM' ||
                                                widget.chartType === 'MapChart' ||
                                                widget.chartType === 'Table' ||
                                                widget.chartType === 'Text'
                                            ) || !widget.chartType"
                                                class="flex flex-col items-center justify-center h-full text-gray-500 bg-gray-50 p-4 rounded-lg">
                                                <mat-icon class="text-6xl text-gray-400" svgIcon="mat_solid:widgets">widgets</mat-icon>
                                                <p class="text-lg font-medium mt-2">No Chart or Data</p>
                                                <p class="text-sm text-center">Configure widget type or add data.</p>
                                            </div>
                                        </ng-container>
                                    </div>
                                    <div class="widget-info text-sm text-gray-600 flex-shrink-0 pt-2 relative z-10" *ngIf="!isWidgetInfoHidden(widget._id!)">
                                        <span class="widget-size block mb-2">Size: {{ widget.columnSize }}x{{ widget.rowSize }}</span>

                                        <!-- If 1x1 (including PIE 1x1), use popup link like PIE 1x1 -->
                                        <div *ngIf="isPieChartOneByOne(widget) || isNonPieChartOneByOne(widget); else defaultDataSourceBlock">
                                            <div class="widget-source-container" *ngIf="getUniqueDataSourceNames(widget).length > 0">
                                                <span class="font-medium">Data Source:</span>
                                                <span cdkOverlayOrigin #origin="cdkOverlayOrigin"></span>
                                                <button type="button" (click)="openQuickInfo(origin, widget, $event)"
                                                    class="text-blue-600 hover:text-blue-800 text-xs px-2 relative z-10">
                                                    Show more...
                                                </button>

                                                <!-- Popover overlay -->
                                                <ng-template
                                                    cdkConnectedOverlay
                                                    [cdkConnectedOverlayOrigin]="origin"
                                                    [cdkConnectedOverlayOpen]="quickInfoOpen && quickInfoWidget?._id === widget._id"
                                                    [cdkConnectedOverlayPositions]="positions"
                                                    [cdkConnectedOverlayHasBackdrop]="true"
                                                    (backdropClick)="closeQuickInfo($event)"
                                                >
                                                    <div class="quick-info-card shadow-lg rounded-xl border border-gray-200 bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/70 min-w-[280px] max-w-[360px]">
                                                        <div class="px-3 py-2 flex items-center justify-between border-b border-gray-100">
                                                            <div class="flex items-center gap-2 text-gray-700 text-sm font-semibold">
                                                                <mat-icon class="text-base text-blue-500">source</mat-icon>
                                                                <span>Data Source</span>
                                                            </div>
                                                            <button type="button" class="text-gray-500 hover:text-gray-700"
                                                                (click)="closeQuickInfo($event)">
                                                                <mat-icon class="text-base">close</mat-icon>
                                                            </button>
                                                        </div>
                                                        <div class="p-3">
                                                            <div class="text-[13px] font-medium text-slate-600 mb-1" *ngIf="quickInfoWidget?.title">{{ quickInfoWidget?.title }}</div>
                                                            <div class="text-[11px] text-slate-500 mb-2">Total sources: {{ getUniqueDataSourceNames(quickInfoWidget!).length }}</div>
                                                            <div class="max-h-[220px] overflow-auto grid gap-1">
                                                                <div *ngFor="let name of getUniqueDataSourceNames(quickInfoWidget!)"
                                                                    class="px-2 py-1 rounded-md text-[12px] bg-blue-50 text-blue-800">
                                                                    {{ name }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </div>
                                        </div>

                                        <!-- Default behavior for other charts -->
                                        <ng-template #defaultDataSourceBlock>
                                        <div class="widget-source-container"
                                                *ngIf="getUniqueDataSourceNames(widget).length > 0; else noDataSource">
                                                <span class="font-medium block mb-1">Data Source:</span>
                                                <div class="flex flex-wrap gap-1">
                                                    <span *ngFor="let name of getUniqueDataSourceNames(widget) | slice:0: (isDataSourceExpanded(widget._id!) ? 9999 : initialVisibleDataSourceTags)"
                                                        class="px-2 py-0.5 bg-blue-100 h-[24px] text-blue-800 rounded-full text-xs font-medium">
                                                        {{ name }}
                                                    </span>
                                                    <button *ngIf="getUniqueDataSourceNames(widget).length > initialVisibleDataSourceTags"
                                                        (click)="toggleDataSourceExpansion(widget._id!)"
                                                        class="text-blue-600 h-[24px] hover:text-blue-800 text-xs py-0 px-2 min-w-0">
                                                        {{ isDataSourceExpanded(widget._id!) ? 'Show less...' : 'Show more...' }}
                                                    </button>
                                                </div>
                                            </div>
                                            <ng-template #noDataSource>
                                                <span class="widget-source block mt-1 text-gray-500 text-xs">No data source defined.</span>
                                            </ng-template>
                                            </ng-template>
                                        </div>
                                </div>
                                <!-- Bottom-right toggle button to show/hide widget description -->
                                <button
                                    mat-mini-fab
                                    color="primary"
                                    class="toggle-info-btn"
                                    type="button"
                                    aria-label="Toggle widget details"
                                    [matTooltip]="isWidgetInfoHidden(widget._id!) ? 'Show details' : 'Hide details'"
                                    (click)="toggleWidgetInfo(widget._id!)">
                                    <mat-icon class="text-base">{{ isWidgetInfoHidden(widget._id!) ? 'unfold_more' : 'unfold_less' }}</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </ng-container>

                <div *ngIf="!dashboard?.sectionIds || dashboard?.sectionIds.length === 0"
                    class="flex flex-col items-center justify-center h-full p-8 text-gray-600">
                    <mat-icon class="text-6xl text-gray-400 mb-4" svgIcon="mat_solid:tab_unselected"></mat-icon>
                    <p class="text-lg font-medium mb-2">No sections added yet!</p>
                    <p class="text-center mb-6">Start building your dashboard by adding a new section.</p>
                    <button mat-raised-button color="primary" (click)="addSection()"
                        class="flex items-center space-x-2 px-8 py-4 rounded-lg shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 text-lg">
                        <mat-icon class="text-2xl" svgIcon="mat_solid:add"></mat-icon>
                        <span>Add Your First Section</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</app-admin-layout>
<app-admin-layout>
    <div class="dashboard-builder flex flex-col h-screen bg-gray-100">
        <div
            class="header flex flex-col sm:flex-row justify-between items-center px-6 py-5 border-b border-gray-200 bg-white shadow-sm z-10 sticky top-0">
            <div class="header-left flex items-center gap-4 mb-4 sm:mb-0">
                <button mat-button (click)="goBack()" class="text-blue-600 hover:text-blue-800">
                    <mat-icon>arrow_back</mat-icon>
                    <span class="ml-2">Back to Dashboards</span>
                </button>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">
                    {{ dashboard?.title || 'Loading Dashboard...' }}
                </h1>
            </div>
            <div class="header-actions flex gap-3">
                <button mat-button (click)="addSection()" matTooltip="Add New Section"
                    class="flex items-center space-x-1 px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors duration-200">
                    <mat-icon>add</mat-icon>
                    <span>Add Section</span>
                </button>
                <button mat-raised-button color="primary" (click)="saveDashboard()"
                    class="flex items-center space-x-2 px-6 py-3 rounded-lg shadow-md hover:shadow-lg transition-all duration-300">
                    <mat-icon>save</mat-icon>
                    <span>Save Dashboard</span>
                </button>
            </div>
        </div>

        <div class="builder-content flex-1 overflow-hidden">
            <!-- Custom draggable tab headers -->
            <div class="custom-tab-header flex border-b border-gray-200 bg-white" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="onSectionDrop($event)">
                <div *ngFor="let section of dashboard?.sectionIds; trackBy: trackById; let i = index" 
                     cdkDrag 
                     class="custom-tab-item px-4 py-3"
                     [class.active-tab]="selectedTabIndex === i"
                     (click)="selectedTabIndex = i; onTabChange(i)">
                    <div class="flex items-center gap-2">
                        <mat-icon cdkDragHandle>drag_indicator</mat-icon>
                        <span>{{ section.title }}</span>
                    </div>
                </div>
                <div *ngIf="!dashboard?.sectionIds || dashboard?.sectionIds.length === 0" 
                     class="custom-tab-item px-4 py-3 active-tab">
                    <span>No Sections</span>
                </div>
            </div>

            <!-- Tab content -->
            <div class="tab-content flex-1 overflow-auto">
                <ng-container *ngIf="dashboard?.sectionIds && dashboard?.sectionIds.length > 0">
                    <div *ngFor="let section of dashboard?.sectionIds; let i = index" [hidden]="selectedTabIndex !== i" class="h-full">
                        <div class="section-header flex justify-between items-center py-4 px-6 bg-white border-b border-gray-200 shadow-sm">
                            <div class="section-info">
                                <h3 class="text-xl font-semibold text-gray-800">
                                    {{ section.title }}
                                </h3>
                                <span class="text-sm text-gray-500">{{ section?.widgetIds.length }} widgets</span>
                            </div>
                            <div class="section-actions flex gap-2">
                                <button mat-icon-button (click)="editSection(section)" matTooltip="Edit Section"
                                    class="text-gray-600 hover:text-blue-600">
                                    <mat-icon>edit</mat-icon>
                                </button>
                                <button mat-icon-button (click)="deleteSection(section)" matTooltip="Delete Section"
                                    class="text-gray-600 hover:text-red-600">
                                    <mat-icon>delete</mat-icon>
                                </button>
                                <button mat-icon-button (click)="addWidget(section)" matTooltip="Add Widget to Section"
                                    class="text-gray-600 hover:text-green-600">
                                    <mat-icon>add_box</mat-icon>
                                </button>
                            </div>
                        </div>

                        <div class="widget-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-6 p-6 overflow-y-auto"
                            cdkDropList [cdkDropListData]="section?.widgetIds"
                            (cdkDropListDropped)="onWidgetDrop($event, i)">
                            <div class="widget-card bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-blue-400 transition-all duration-300 ease-in-out cursor-grab flex flex-col"
                                *ngFor="let widget of section?.widgetIds; trackBy: trackById" cdkDrag
                                [class.col-span-1]="widget.columnSize === 1"
                                [class.col-span-2]="widget.columnSize === 2"
                                [class.col-span-3]="widget.columnSize === 3"
                                [class.col-span-4]="widget.columnSize === 4" [class.row-span-1]="widget.rowSize === 1"
                                [class.row-span-2]="widget.rowSize === 2" [class.row-span-3]="widget.rowSize === 3"
                                [class.row-span-4]="widget.rowSize === 4" #widgetCard>
                                <ng-template cdkDragPreview>
                                    <div
                                        class="simplified-widget-preview bg-blue-500 text-white p-3 rounded-lg shadow-lg flex items-center justify-center">
                                        <mat-icon>drag_indicator</mat-icon>
                                        <span class="ml-2 text-sm font-medium">{{ widget.title }}</span>
                                    </div>
                                </ng-template>

                                <ng-template cdkDragPlaceholder>
                                    <div
                                        class="widget-placeholder border-2 border-dashed border-gray-400 rounded-lg bg-gray-100 opacity-50 flex items-center justify-center">
                                    </div>
                                </ng-template>

                                <div
                                    class="widget-header flex justify-between items-center p-4 border-b border-gray-100">
                                    <h3 class="text-base font-medium text-gray-900 truncate">{{ widget.title }}</h3>
                                    <div class="widget-actions flex gap-1">
                                        <button mat-icon-button matTooltip="Edit Widget" (click)="editWidget(widget)"
                                            class="text-gray-500 hover:text-blue-600">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                        <button mat-icon-button matTooltip="Delete Widget"
                                            (click)="deleteWidget(widget)" class="text-gray-500 hover:text-red-600">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                        <button mat-icon-button cdkDragHandle matTooltip="Move Widget"
                                            class="text-gray-500 hover:text-gray-800 cursor-grab">
                                            <mat-icon>drag_indicator</mat-icon>
                                        </button>
                                    </div>
                                </div>

                                <div class="widget-content flex-grow flex flex-col justify-between p-4">
                                    <div class="mb-4">
                                        <ng-container [ngSwitch]="widget.chartType">
                                            <app-metric-widget *ngSwitchCase="'CARD'" [widget]="widget"
                                                [data]="widget.data"></app-metric-widget>
                                            <app-bar-chart-widget *ngSwitchCase="'CLUSTERED_BAR_CHART'"
                                                [widget]="widget" [data]="widget.data"></app-bar-chart-widget>
                                            <app-column-chart-widget *ngSwitchCase="'ColumnChart'" [widget]="widget"
                                                [data]="widget.data"></app-column-chart-widget>
                                            <app-line-chart-widget *ngSwitchCase="'LINE_CHART_WITH_DATA_LABELS'"
                                                [widget]="widget" [data]="widget.data"></app-line-chart-widget>
                                            <app-pie-chart-widget *ngSwitchCase="'PIE_CHART_BROKEN_DOWN_SLICES'"
                                                [widget]="widget" [data]="widget.data"></app-pie-chart-widget>
                                            <app-sankey-chart-widget *ngSwitchCase="'TRACEABLE_SANKEY_DIAGRAM'"
                                                [widget]="widget" [data]="widget.data"></app-sankey-chart-widget>
                                            <app-map-widget *ngSwitchCase="'CLUSTERED_COLUMN_CHART'" [widget]="widget"
                                                [data]="widget.data"></app-map-widget>
                                            <app-simple-table-widget *ngSwitchCase="'Table'" [widget]="widget"
                                                [data]="widget.data"></app-simple-table-widget>
                                            <app-text-widget *ngSwitchCase="'Text'" [widget]="widget"
                                                [data]="widget.data"></app-text-widget>
                                            <app-pictorial-fraction-chart *ngSwitchCase="'PICTORIAL_FRACTION_CHART'"
                                                [widget]="widget" [data]="widget.data"></app-pictorial-fraction-chart>
                                            <app-status-grid-widget *ngSwitchCase="'StatusGrid'" [widget]="widget"
                                                [data]="widget.data"></app-status-grid-widget>
                                            <app-map-widget *ngSwitchCase="'DRILL_DOWN_MAP'" [widget]="widget"
                                                [data]="widget.data"></app-map-widget>
                                            <div *ngSwitchDefault
                                                class="flex flex-col items-center justify-center h-full text-gray-500 bg-gray-50 p-4 rounded-lg">
                                                <mat-icon class="text-6xl text-gray-400"
                                                    svgIcon="mat_solid:widgets">widgets</mat-icon>
                                                <p class="text-lg font-medium mt-2">No Chart or Data</p>
                                                <p class="text-sm text-center">Configure widget type or add data.</p>
                                            </div>
                                        </ng-container>
                                    </div>
                                    <div class="widget-info text-sm text-gray-600">
                                        <span class="widget-size block mb-2">Size: {{ widget.columnSize }}x{{
                                            widget.rowSize }}</span>
                                        <div class="widget-source-container"
                                            *ngIf="getUniqueDataSourceNames(widget).length > 0; else noDataSource">
                                            <span class="font-medium block mb-1">Data Source:</span>
                                            <div class="flex flex-wrap gap-1">
                                                <span *ngFor="
                            let name of getUniqueDataSourceNames(widget) | slice:0: (isDataSourceExpanded(widget._id!) ? 9999 : initialVisibleDataSourceTags)
                          " class="px-2 py-0.5 bg-blue-100 h-[24px] text-blue-800 rounded-full text-xs font-medium">
                                                    {{ name }}
                                                </span>
                                                <button
                                                    *ngIf="getUniqueDataSourceNames(widget).length > initialVisibleDataSourceTags"
                                                    (click)="toggleDataSourceExpansion(widget._id!)"
                                                    class="text-blue-600 h-[24px] hover:text-blue-800 text-xs py-0 px-2 min-w-0">
                                                    {{ isDataSourceExpanded(widget._id!) ? 'Show less...' : 'Show
                                                    more...' }}
                                                </button>
                                            </div>
                                        </div>
                                        <ng-template #noDataSource>
                                            <span class="widget-source block mt-1 text-gray-500 text-xs">No data source
                                                defined.</span>
                                        </ng-template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </ng-container>

                <div *ngIf="!dashboard?.sectionIds || dashboard?.sectionIds.length === 0" class="flex flex-col items-center justify-center h-full p-8 text-gray-600">
                    <mat-icon class="text-6xl text-gray-400 mb-4" svgIcon="mat_solid:tab_unselected"></mat-icon>
                    <p class="text-lg font-medium mb-2">No sections added yet!</p>
                    <p class="text-center mb-6">Start building your dashboard by adding a new section.</p>
                    <button mat-raised-button color="primary" (click)="addSection()"
                        class="flex items-center space-x-2 px-8 py-4 rounded-lg shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 text-lg">
                        <mat-icon class="text-2xl" svgIcon="mat_solid:add"></mat-icon>
                        <span>Add Your First Section</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</app-admin-layout>
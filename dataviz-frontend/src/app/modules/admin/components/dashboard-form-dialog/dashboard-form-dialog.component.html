<div class="dashboard-form-dialog flex flex-col bg-white rounded-lg shadow-2xl border border-gray-300 overflow-hidden">
  <div class="header flex justify-between items-center px-6 py-4 border-b border-gray-200 bg-gray-50">
    <h2 class="text-xl font-semibold text-gray-800">
      {{ isEditMode ? 'Edit Dashboard' : 'Create New Dashboard' }}
    </h2>
    <button mat-icon-button (click)="onCancel()" aria-label="Close dialog">
      <mat-icon class="text-gray-600 hover:text-gray-800">close</mat-icon>
    </button>
  </div>

  <form [formGroup]="dashboardForm" (ngSubmit)="onSubmit()" class="flex-grow">
    <mat-dialog-content class="py-6 px-6">
      <div class="form-fields flex flex-col gap-5">
        <mat-form-field class="w-full">
          <mat-label>Dashboard Name (Slug)</mat-label>
          <input matInput formControlName="name" placeholder="e.g., sales-report-2024"
            class="rounded-md border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" />
          <mat-error *ngIf="dashboardForm.get('name')?.hasError('required') && dashboardForm.get('name')?.touched">
            Name is required
          </mat-error>
        </mat-form-field>

        <mat-form-field class="w-full">
          <mat-label>Dashboard Title</mat-label>
          <input matInput formControlName="title" placeholder="e.g., 2024 Annual Sales Report"
            class="rounded-md border border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" />
          <mat-error *ngIf="dashboardForm.get('title')?.hasError('required') && dashboardForm.get('title')?.touched">
            Title is required
          </mat-error>
        </mat-form-field>

        <div class="sources-section w-full border border-gray-200 rounded-lg p-4 mt-2">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex justify-between items-center">
            Sources
            <button mat-flat-button color="primary" type="button" (click)="addSource()">
              <mat-icon>add</mat-icon> Add Source
            </button>
          </h3>

          <div formArrayName="sourcesFormArray" class="flex flex-col gap-4">
            <div *ngFor="let sourceGroup of sourcesFormArray.controls; let i = index" [formGroupName]="i"
              class="source-item flex flex-col sm:flex-row gap-4 p-4 border border-gray-300 rounded-md bg-gray-50 items-start sm:items-center relative">
              <div class="flex-grow grid gap-4 w-full" [class.grid-cols-2]="getFilteredClasses(sourceGroup).length > 0"
                [class.grid-cols-1]="getFilteredClasses(sourceGroup).length === 0">
                <mat-form-field class="w-full">
                  <mat-label>Certification</mat-label>
                  <mat-select formControlName="certification"
                    (selectionChange)="onCertificationChange(sourceGroup, $event.value)">
                    <mat-option *ngFor="let source of allSources" [value]="source.certification">
                      {{ source.certification }}
                    </mat-option>
                  </mat-select>
                  <mat-error
                    *ngIf="sourceGroup.get('certification')?.hasError('required') && sourceGroup.get('certification')?.touched">
                    Certification is required
                  </mat-error>
                </mat-form-field>

                <mat-form-field class="w-full" *ngIf="getFilteredClasses(sourceGroup).length > 0">
                  <mat-label>Class</mat-label>
                  <mat-select formControlName="classes" [multiple]="true">
                    <mat-option *ngFor="let cls of getFilteredClasses(sourceGroup)" [value]="cls">
                      {{ cls }}
                    </mat-option>
                  </mat-select>
                  <mat-hint>Select one or more classes for the certification.</mat-hint>
                </mat-form-field>
              </div>

              <mat-icon (click)="removeSource(i)" *ngIf="sourcesFormArray.length > 1"
                class="absolute w-[42px] h-[42px] top-2 cursor-pointer right-2 text-red-500 hover:text-red-800">delete</mat-icon>
            </div>
            <p class="text-sm text-gray-500 mt-2" *ngIf="sourcesFormArray.length === 0">
              Please add at least one source for this dashboard.
            </p>
          </div>
        </div>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end" class="px-6 py-4 border-t border-gray-200 bg-gray-50">
      <button mat-button type="button" (click)="onCancel()"
        class="px-5 py-2.5 rounded-md text-gray-700 hover:bg-gray-200 transition-colors duration-200 shadow-sm hover:shadow-md">
        Cancel
      </button>
      <button mat-raised-button color="primary" type="submit"
        [disabled]="dashboardForm.invalid || sourcesFormArray.length === 0"
        class="px-6 py-2.5 rounded-md shadow-md hover:shadow-lg transition-all duration-300">
        {{ isEditMode ? 'Save Changes' : 'Create Dashboard' }}
      </button>
    </mat-dialog-actions>
  </form>
</div>